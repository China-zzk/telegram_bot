name: Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 允许手动触发
  repository_dispatch: # 允许通过API触发
    types: [run-bot-deployment]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.action == 'run-bot-deployment'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug - Show trigger info
      run: |
        echo "工作流触发方式: ${{ github.event_name }}"
        echo "触发分支: ${{ github.ref }}"
        echo "仓库: ${{ github.repository }}"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Make run_bot.sh executable
      run: chmod +x run_bot.sh

    - name: Validate environment variables
      run: |
        if [ -z "${{ secrets.COMMAND_GROUP_ID }}" ]; then
          echo "❌ 错误: COMMAND_GROUP_ID 环境变量未设置"
          exit 1
        fi
        echo "✅ 环境变量验证通过"

    - name: Run Telegram Bots
      env:
        # 消息转发机器人的环境变量
        MESSAGE_BOT_TOKEN: ${{ secrets.MESSAGE_BOT_TOKEN }}
        YOUR_CHAT_ID: ${{ secrets.YOUR_CHAT_ID }}
        KEYWORD_GROUP_ID: ${{ secrets.KEYWORD_GROUP_ID }}  # 关键词转发群聊ID
        KEYWORDS: ${{ secrets.KEYWORDS }}  # 关键词列表
        # 命令机器人的环境变量
        COMMAND_BOT_TOKEN: ${{ secrets.COMMAND_BOT_TOKEN }}
        COMMAND_GROUP_ID: ${{ secrets.COMMAND_GROUP_ID }}  # 必需：命令群聊ID
        TOKEN: ${{ secrets.TOKEN }}
        REPO_FULL_NAME: ${{ github.repository }}
      run: |
        echo "启动 Telegram 机器人..."
        echo "命令群聊ID: $COMMAND_GROUP_ID"
        echo "监控关键词: $KEYWORDS"
        echo "关键词转发群聊: $KEYWORD_GROUP_ID"
        ./run_bot.sh